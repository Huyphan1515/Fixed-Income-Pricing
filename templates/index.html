<!-- ... retain your HTML head and styles ... -->
<form id="bond-form" class="row g-3">
  <div class="col-6">
    <label class="form-label">Bond Type</label>
    <select id="bondType" name="bond_type" class="form-select" required>
      <option value="zero">Zero Coupon</option>
      <option value="fixed">Fixed Coupon</option>
      <option value="floating">Floating Coupon</option>
    </select>
  </div>
  <div class="col-6" id="div_discount_rate">
    <label class="form-label">Discount Rate (%)</label>
    <input id="discount_rate" name="discount_rate" type="number" step="0.01" class="form-control" required />
  </div>
  <div class="col-6" id="div_face_value">
    <label class="form-label">Bond Face Value</label>
    <input name="face_value" type="number" class="form-control" required />
  </div>
  <div class="col-6" id="div_coupon_rate">
    <label class="form-label">Coupon Rate (%)</label>
    <input name="coupon_rate" type="number" step="0.5" class="form-control" />
  </div>
  <div class="col-6" id="div_frequency">
    <label class="form-label">Coupon Frequency</label>
    <select name="frequency" class="form-select">
      <option value="1">Annual</option>
      <option value="2">Semi-Annual</option>
      <option value="4">Quarterly</option>
    </select>
  </div>
  <div class="col-6" id="div_num_periods" style="display:none;">
    <label class="form-label">Number of Coupon Periods</label>
    <input id="num_periods" name="num_periods" type="number" min="1" max="50" class="form-control" />
  </div>
  <div class="col-12" id="div_coupon_rate_table" style="display:none;">
    <label>Enter Rate for Each Period</label>
    <table class="table" id="coupon_rate_table">
      <thead>
        <tr><th>Period</th><th>Rate (%)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- ... keep the rest of your form unchanged ... -->
  <!-- Just be sure to keep the original names for your backend -->
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const bondType = document.getElementById('bondType');
  const divDiscount = document.getElementById('div_discount_rate');
  const divFaceVal = document.getElementById('div_face_value');
  const divCoupon = document.getElementById('div_coupon_rate');
  const divFreq = document.getElementById('div_frequency');
  const divNumPeriods = document.getElementById('div_num_periods');
  const divTable = document.getElementById('div_coupon_rate_table');
  const numPeriods = document.getElementById('num_periods');
  const couponTable = document.getElementById('coupon_rate_table').querySelector('tbody');

  function updateForm() {
    if (bondType.value === 'zero') {
      divDiscount.style.display = '';
      divCoupon.style.display = 'none';
      divFreq.style.display = 'none';
      divNumPeriods.style.display = 'none';
      divTable.style.display = 'none';
    } else {
      divDiscount.style.display = '';
      divCoupon.style.display = '';
      divFreq.style.display = '';
      divNumPeriods.style.display = '';
      // Show/hide table depending on numPeriods
      if (numPeriods.value > 0) divTable.style.display = '';
    }
  }
  bondType.addEventListener('change', function() {
    updateForm();
  });
  numPeriods.addEventListener('input', function() {
    couponTable.innerHTML = '';
    let n = parseInt(numPeriods.value, 10);
    if (isNaN(n) || n <= 0) {
      divTable.style.display = 'none';
      return;
    }
    divTable.style.display = '';
    for (let i = 1; i <= n; i++) {
      let row = document.createElement('tr');
      row.innerHTML = `<td>${i}</td>
        <td><input type="number" name="rate_period_${i}" step="0.01" required class="form-control" /></td>`;
      couponTable.appendChild(row);
    }
  });
  updateForm();

  document.getElementById("bond-form").onsubmit = async function (e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = {};
    formData.forEach((v, k) => {
      data[k] = isNaN(v) || v === "" ? v : parseFloat(v);
    });
    data.apply_trading_fee = data.apply_trading_fee === "Yes";
    data.bond_type = bondType.value;

    // For fixed/floating, collect coupon_rates array
    if (bondType.value === "fixed" || bondType.value === "floating") {
      data.coupon_rates = [];
      let n = parseInt(numPeriods.value, 10);
      for (let i = 1; i <= n; i++) {
        const val = form.querySelector(`[name=rate_period_${i}]`).value;
        data.coupon_rates.push(parseFloat(val));
      }
    }
    // For zero-coupon, coupon_rates is empty
    else {
      data.coupon_rates = [];
      data.num_periods = 0;
    }

    try {
      const res = await fetch("/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      const json = await res.json();
      // ... render results as before ...
      // (You can keep your current result rendering logic here.)
    } catch (err) {
      alert("Something went wrong. Please check console for details.");
      console.error(err);
    }
  };
});
</script>
